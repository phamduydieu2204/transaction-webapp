<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Trang quản lý giao dịch</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto">
    <h2 class="text-2xl font-bold text-blue-600 mb-4">Nhập giao dịch</h2>

    <div id="formGiaoDich" class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-white p-6 rounded-xl shadow">
      <div>
        <label class="block font-medium mb-1">Loại giao dịch</label>
        <select id="loaiGiaoDich" class="w-full border border-gray-300 p-2 rounded">
          <option value="Mua hàng">Mua hàng</option>
          <option value="Đổi gói">Đổi gói</option>
          <option value="Hoàn trả">Hoàn trả</option>
        </select>
      </div>
      <div>
        <label class="block font-medium mb-1">Tên khách hàng</label>
        <input type="text" id="tenKhachHang" class="w-full border border-gray-300 p-2 rounded" />
      </div>
      <div>
        <label class="block font-medium mb-1">Email</label>
        <input type="email" id="email" class="w-full border border-gray-300 p-2 rounded" />
      </div>
      <div>
        <label class="block font-medium mb-1">Liên hệ</label>
        <input type="text" id="lienHe" class="w-full border border-gray-300 p-2 rounded" />
      </div>
      <div>
        <label class="block font-medium mb-1">Số tháng đăng ký</label>
        <input type="number" id="soThangDangKy" min="1" class="w-full border border-gray-300 p-2 rounded" />
      </div>
      <div>
        <label class="block font-medium mb-1">Ngày bắt đầu</label>
        <input type="text" id="ngayBatDau" placeholder="dd/mm/yyyy" class="w-full border border-gray-300 p-2 rounded" />
      </div>
      <div>
        <label class="block font-medium mb-1">Số thiết bị</label>
        <input type="number" id="soThietBi" min="1" class="w-full border border-gray-300 p-2 rounded" />
      </div>
      <div>
        <label class="block font-medium mb-1">Tên phần mềm</label>
        <select id="tenPhanMem" class="w-full border border-gray-300 p-2 rounded"></select>
      </div>
      <div>
        <label class="block font-medium mb-1">Gói phần mềm</label>
        <select id="goiPhanMem" class="w-full border border-gray-300 p-2 rounded"></select>
      </div>
      <div>
        <label class="block font-medium mb-1">Doanh thu</label>
        <input type="number" id="doanhThu" min="0" class="w-full border border-gray-300 p-2 rounded" />
      </div>
      <div class="md:col-span-2">
        <label class="block font-medium mb-1">Ghi chú</label>
        <input type="text" id="ghiChu" class="w-full border border-gray-300 p-2 rounded" />
      </div>
      <div class="md:col-span-2 text-right">
        <button onclick="themGiaoDich()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded transition">Thêm giao dịch</button>
        <p id="thongBao" class="mt-2 text-red-600"></p>
      </div>
    </div>

    <div id="boLoc" class="mt-10 bg-white p-6 rounded-xl shadow grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block font-medium mb-1">Tên khách hàng</label>
        <input type="text" id="locTenKH" placeholder="Nhập tên khách hàng" class="w-full border border-gray-300 p-2 rounded" />
      </div>
      <div>
        <label class="block font-medium mb-1">Email</label>
        <input type="text" id="locEmail" placeholder="Nhập email" class="w-full border border-gray-300 p-2 rounded" />
      </div>
      <div>
        <label class="block font-medium mb-1">Tên phần mềm</label>
        <input type="text" id="locTenPM" placeholder="Nhập tên phần mềm" class="w-full border border-gray-300 p-2 rounded" />
      </div>
      <div class="md:col-span-3 text-right">
        <button onclick="timKiemGiaoDich()" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded mr-2">Tìm kiếm</button>
        <button onclick="resetBoLoc()" class="bg-gray-300 hover:bg-gray-400 text-black py-2 px-4 rounded">Xóa lọc</button>
      </div>
    </div>

    <h2 class="text-2xl font-bold text-blue-600 mt-10 mb-4">Danh sách giao dịch của bạn</h2>
    <div class="overflow-auto bg-white rounded-xl shadow">
      <table class="w-full text-sm text-left">
        <thead class="bg-blue-600 text-white">
          <tr>
            <th class="p-3">Mã GD</th>
            <th class="p-3">Khách hàng</th>
            <th class="p-3">Email</th>
            <th class="p-3">Phần mềm</th>
            <th class="p-3">Gói</th>
            <th class="p-3">Doanh thu</th>
            <th class="p-3">Bắt đầu</th>
            <th class="p-3">Kết thúc</th>
            <th class="p-3">Hành động</th>
          </tr>
        </thead>
        <tbody id="bangGiaoDichBody" class="bg-white"></tbody>
      </table>
    </div>

    <div id="phanTrang" class="mt-4 flex justify-center items-center gap-4">
      <button onclick="chuyenTrang(-1)" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">← Trang trước</button>
      <span id="soTrangHienTai" class="text-sm font-medium">Trang 1</span>
      <button onclick="chuyenTrang(1)" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Trang sau →</button>
    </div>

    <h2 class="text-2xl font-bold text-blue-600 mt-10 mb-4">Thống kê & Báo cáo</h2>
    <div id="thongKe" class="bg-white p-6 rounded-xl shadow"></div>
    <div class="bg-white p-6 rounded-xl shadow mt-4">
      <canvas id="bieuDo" height="200"></canvas>
    </div>

    <div class="mt-10 text-center">
      <button onclick="dangXuat()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded">Đăng xuất</button>
    </div>
  </div>

  <script>
    const URL_API = 'https://script.google.com/macros/s/AKfycby4zyKgL5_nzsIGXvWGmddmJUWX5G_KDGOE8KEAhoF6N_KXTIzVVuUpx5MsYPFpjH7Q/exec';
    let user = JSON.parse(localStorage.getItem('user') || '{}');
    let danhSachGiaoDich = [];
    let trangHienTai = 1;
    const soDongMoiTrang = 10;

    if (!user.maNhanVien) {
      alert('Vui lòng đăng nhập.');
      window.location.href = 'index.html';
    }

    window.onload = () => {
      document.getElementById('ngayBatDau').value = new Date().toLocaleDateString('vi-VN');
      loadPhanMem();
      loadGiaoDich();
      loadThongKe();
    };

    const getValue = id => document.getElementById(id).value.trim();
    const setValue = (id, val) => document.getElementById(id).value = val;

    async function loadPhanMem() {
      const res = await fetch(`${URL_API}?action=getSoftwares`, { method: 'POST' });
      const data = await res.json();
      if (!data.success) return;

      const tenSelect = document.getElementById('tenPhanMem');
      const goiSelect = document.getElementById('goiPhanMem');
      const list = data.data;
      const tenList = [...new Set(list.map(item => item.tenPhanMem))];

      tenList.forEach(ten => tenSelect.innerHTML += `<option value="${ten}">${ten}</option>`);

      tenSelect.addEventListener('change', () => {
        const selected = tenSelect.value;
        goiSelect.innerHTML = '';
        list.filter(item => item.tenPhanMem === selected)
            .forEach(item => goiSelect.innerHTML += `<option value="${item.goiPhanMem}">${item.goiPhanMem}</option>`);
      });

      tenSelect.dispatchEvent(new Event('change'));
    }

    async function themGiaoDich() {
      const data = thuThongTinForm();
      const res = await fetch(`${URL_API}?action=addTransaction`, {
        method: 'POST',
        body: JSON.stringify({ ...data, maNhanVien: user.maNhanVien, tenNhanVien: user.tenNhanVien })
      });

      const result = await res.json();
      const tb = document.getElementById('thongBao');
      tb.className = result.success ? 'text-green-600' : 'text-red-600';
      tb.textContent = result.message || (result.success ? 'Thêm giao dịch thành công.' : 'Lỗi khi thêm.');
      if (result.success) {
        resetForm();
        loadGiaoDich();
      }
    }

    function thuThongTinForm() {
      const fields = ['loaiGiaoDich','tenKhachHang','email','lienHe','soThangDangKy','ngayBatDau','soThietBi','tenPhanMem','goiPhanMem','doanhThu','ghiChu'];
      const obj = {};
      for (let f of fields) {
        const val = getValue(f);
        if (!val && f !== 'ghiChu') throw alert(`Vui lòng nhập ${f}`);
        obj[f] = f === 'email' ? val.toLowerCase() : val;
      }
      if (!/^\d{2}\/\d{2}\/\d{4}$/.test(obj.ngayBatDau)) throw alert('Sai định dạng ngày (dd/mm/yyyy)');
      return obj;
    }

    async function loadGiaoDich() {
      const res = await fetch(`${URL_API}?action=searchTransaction`, {
        method: 'POST',
        body: JSON.stringify({
          maNhanVien: user.maNhanVien,
          tenNhanVien: user.tenNhanVien,
          vaiTro: user.vaiTro,
          dieuKien: {}
        })
      });
      const data = await res.json();
      if (data.success) {
        danhSachGiaoDich = data.data;
        trangHienTai = 1;
        hienThiTrang();
      }
    }

    function hienThiTrang() {
      const tbody = document.getElementById('bangGiaoDichBody');
      tbody.innerHTML = '';
      const start = (trangHienTai - 1) * soDongMoiTrang;
      const end = Math.min(start + soDongMoiTrang, danhSachGiaoDich.length);

      for (let i = start; i < end; i++) {
        const gd = danhSachGiaoDich[i];
        tbody.innerHTML += `
          <tr class="border-b">
            <td class="p-2">${gd['Ma giao dich']}</td>
            <td class="p-2">${gd['Ten khach hang']}</td>
            <td class="p-2">${gd['Email']}</td>
            <td class="p-2">${gd['Ten phan mem']}</td>
            <td class="p-2">${gd['Goi phan mem']}</td>
            <td class="p-2">${gd['Doanh thu']}</td>
            <td class="p-2">${gd['Ngay bat dau']}</td>
            <td class="p-2">${gd['Ngay ket thuc']}</td>
            <td class="p-2">
              <button class="text-blue-600 mr-2" onclick='suaGiaoDich(${JSON.stringify(gd)})'>Sửa</button>
              <button class="text-red-600" onclick='xoaGiaoDich("${gd['Ma giao dich']}")'>Xóa</button>
            </td>
          </tr>`;
      }

      document.getElementById('soTrangHienTai').textContent = `Trang ${trangHienTai} / ${Math.ceil(danhSachGiaoDich.length / soDongMoiTrang)}`;
    }

    function chuyenTrang(delta) {
      const tongTrang = Math.ceil(danhSachGiaoDich.length / soDongMoiTrang);
      trangHienTai = Math.min(Math.max(1, trangHienTai + delta), tongTrang);
      hienThiTrang();
    }

    function suaGiaoDich(gd) {
      ['loaiGiaoDich','tenKhachHang','email','lienHe','soThangDangKy','ngayBatDau','soThietBi','tenPhanMem','doanhThu','ghiChu']
        .forEach(k => setValue(k, gd[formatKey(k)] || ''));
      document.getElementById('tenPhanMem').dispatchEvent(new Event('change'));
      setTimeout(() => setValue('goiPhanMem', gd['Goi phan mem']), 200);

      document.getElementById('formGiaoDich').dataset.magiaodich = gd['Ma giao dich'];
      document.getElementById('thongBao').textContent = 'Đang chỉnh sửa: ' + gd['Ma giao dich'];
      const btn = document.querySelector('#formGiaoDich button');
      btn.textContent = 'Cập nhật giao dịch';
      btn.onclick = capNhatGiaoDich;
    }

    function formatKey(key) {
      return key.replace(/([a-z])([A-Z])/g, '$1 $2').replace(/([A-Z])/g, m => ' ' + m).replace(/^./, s => s.toUpperCase());
    }

    async function capNhatGiaoDich() {
      const maGiaoDich = document.getElementById('formGiaoDich').dataset.magiaodich;
      if (!maGiaoDich) return;

      const res = await fetch(`${URL_API}?action=editTransaction`, {
        method: 'POST',
        body: JSON.stringify({
          ...thuThongTinForm(),
          maGiaoDich,
          maNhanVien: user.maNhanVien,
          tenNhanVien: user.tenNhanVien,
          vaiTro: user.vaiTro
        })
      });
      const data = await res.json();
      if (data.success) {
        alert('Cập nhật thành công!');
        resetForm();
        loadGiaoDich();
      } else {
        alert(data.message || 'Lỗi khi cập nhật.');
      }
    }

    async function xoaGiaoDich(maGiaoDich) {
      if (!confirm('Bạn có chắc muốn xóa giao dịch này?')) return;
      const res = await fetch(`${URL_API}?action=deleteTransaction`, {
        method: 'POST',
        body: JSON.stringify({ maGiaoDich, maNhanVien: user.maNhanVien, tenNhanVien: user.tenNhanVien, vaiTro: user.vaiTro })
      });
      const data = await res.json();
      if (data.success) {
        alert('Đã xóa giao dịch.');
        loadGiaoDich();
      } else {
        alert(data.message || 'Lỗi khi xóa.');
      }
    }

    function resetForm() {
      document.getElementById('formGiaoDich').reset();
      document.getElementById('thongBao').textContent = '';
      delete document.getElementById('formGiaoDich').dataset.magiaodich;
      const btn = document.querySelector('#formGiaoDich button');
      btn.textContent = 'Thêm giao dịch';
      btn.onclick = themGiaoDich;
    }

    async function loadThongKe() {
      const res = await fetch(`${URL_API}?action=getStats`, {
        method: 'POST',
        body: JSON.stringify({ maNhanVien: user.maNhanVien, vaiTro: user.vaiTro })
      });
      const data = await res.json();
      if (!data.success) return;

      const { doanhThu, tongGD, phanMemPhoBien } = data.data;
      document.getElementById('thongKe').innerHTML = `
        <p class="font-semibold">Doanh thu:</p>
        <ul class="list-disc ml-6 text-sm">
          <li>Hôm nay: ${doanhThu.ngay.toLocaleString('vi-VN')}</li>
          <li>Tháng này: ${doanhThu.thang.toLocaleString('vi-VN')}</li>
          <li>Năm nay: ${doanhThu.nam.toLocaleString('vi-VN')}</li>
        </ul>
        <p class="mt-2 font-semibold">Tổng số giao dịch: ${tongGD}</p>
      `;

      if (phanMemPhoBien.length) {
        const ctx = document.getElementById('bieuDo').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: phanMemPhoBien.map(pm => pm.label),
            datasets: [{ label: 'Số lần sử dụng', data: phanMemPhoBien.map(pm => pm.value) }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              title: { display: true, text: 'Top phần mềm phổ biến' }
            }
          }
        });
      }
    }

    async function timKiemGiaoDich() {
      const dieuKien = {};
      if (getValue('locTenKH')) dieuKien['Ten khach hang'] = getValue('locTenKH');
      if (getValue('locEmail')) dieuKien['Email'] = getValue('locEmail');
      if (getValue('locTenPM')) dieuKien['Ten phan mem'] = getValue('locTenPM');

      const res = await fetch(`${URL_API}?action=searchTransaction`, {
        method: 'POST',
        body: JSON.stringify({
          maNhanVien: user.maNhanVien,
          tenNhanVien: user.tenNhanVien,
          vaiTro: user.vaiTro,
          dieuKien
        })
      });

      const data = await res.json();
      if (data.success) {
        danhSachGiaoDich = data.data;
        trangHienTai = 1;
        hienThiTrang();
      } else {
        alert('Không tìm thấy kết quả.');
      }
    }

    function resetBoLoc() {
      ['locTenKH','locEmail','locTenPM'].forEach(id => setValue(id, ''));
      loadGiaoDich();
    }

    function dangXuat() {
      localStorage.removeItem('user');
      window.location.href = 'index.html';
    }
  </script>
  <!-- Script và Chart.js thêm sau -->
</body>
</html>