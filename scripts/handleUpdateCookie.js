import { getConstants } from './constants.js';
import { showResultModal } from './showResultModal.js';
import { showProcessingModal } from './showProcessingModal.js';
import { closeProcessingModal } from './closeProcessingModal.js';

export async function handleUpdateCookie(index, transactionList) {
  console.log('üç™ handleUpdateCookie called with:', { index, transactionListLength: transactionList?.length });
  
  const transaction = transactionList?.[index];
  console.log('üç™ Found transaction:', transaction);
  
  if (!transaction) {
    console.error('‚ùå No transaction found at index:', index);
    return alert("Kh√¥ng t√¨m th·∫•y giao d·ªãch.");
  }

  const modal = document.getElementById("updateCookieModal");
  console.log('üç™ Modal found:', !!modal);
  const currentCookieEl = document.getElementById("currentCookie");
  const newCookieEl = document.getElementById("newCookie");

  currentCookieEl.value = "";
  newCookieEl.value = "";
  window.currentCookieTransaction = transaction;

  // L·∫•y cookie hi·ªán t·∫°i
  try {
    const { BACKEND_URL } = getConstants();
    showProcessingModal("ƒêang t·∫£i cookie...");
    const response = await fetch(BACKEND_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        action: "getCookie",
        accountSheetId: transaction.accountSheetId
      })
    });
    const result = await response.json();
    currentCookieEl.value = result.cookie || "(Kh√¥ng c√≥ d·ªØ li·ªáu)";
    closeProcessingModal();
    modal.style.display = "block";
  } catch (err) {
    closeProcessingModal();
    showResultModal("Kh√¥ng th·ªÉ t·∫£i cookie: " + err.message, false);
  }
}

export function copyCurrentCookie() {
  console.log('üç™ copyCurrentCookie called');
  
  const val = document.getElementById("currentCookie").value;
  console.log('üç™ Current cookie value:', val);
  
  if (!val || val === "(Kh√¥ng c√≥ d·ªØ li·ªáu)") {
    showResultModal("‚ö†Ô∏è Kh√¥ng c√≥ cookie ƒë·ªÉ sao ch√©p!", false);
    return;
  }
  
  navigator.clipboard.writeText(val).then(() => {
    console.log('‚úÖ Cookie copied successfully');
    showResultModal("‚úÖ ƒê√£ sao ch√©p cookie th√†nh c√¥ng!", true);
  }).catch((err) => {
    console.error('‚ùå Copy failed:', err);
    showResultModal("‚ùå Kh√¥ng th·ªÉ sao ch√©p cookie!", false);
  });
}

export function testCurrentCookie() {
  console.log('üß™ testCurrentCookie called');
  
  const val = document.getElementById("currentCookie").value;
  console.log('üß™ Cookie to test:', val);
  
  if (!val || val === "(Kh√¥ng c√≥ d·ªØ li·ªáu)") {
    showResultModal("‚ö†Ô∏è Kh√¥ng c√≥ cookie ƒë·ªÉ test!", false);
    return;
  }
  
  // Store cookie for testing
  window.currentTestCookie = val;
  
  // Show test modal
  const testModal = document.getElementById("testCookieModal");
  if (testModal) {
    testModal.style.display = "block";
    
    // Reset form
    document.getElementById("testWebsite").value = "";
    document.getElementById("customWebsite").value = "";
    document.getElementById("customWebsiteDiv").style.display = "none";
    document.getElementById("testResults").style.display = "none";
    
    // Add website change handler
    const websiteSelect = document.getElementById("testWebsite");
    websiteSelect.onchange = function() {
      const customDiv = document.getElementById("customWebsiteDiv");
      if (this.value === "custom") {
        customDiv.style.display = "block";
      } else {
        customDiv.style.display = "none";
      }
    };
  } else {
    console.error('‚ùå Test cookie modal not found');
    showResultModal("‚ùå Kh√¥ng t√¨m th·∫•y modal test cookie!", false);
  }
}

export async function confirmUpdateCookie() {
  console.log('üç™ confirmUpdateCookie called');
  
  try {
    disableInteraction();
    const transaction = window.currentCookieTransaction;
    console.log('üç™ Current transaction:', transaction);
    
    const newCookieEl = document.getElementById("newCookie");
    console.log('üç™ New cookie element found:', !!newCookieEl);
    
    const newCookie = newCookieEl?.value.trim();
    console.log('üç™ New cookie value:', newCookie);

    if (!transaction || !transaction.transactionId) {
      console.error('‚ùå No transaction or transaction ID');
      enableInteraction();
      return;
    }
    
    // Ki·ªÉm tra cookie m·ªõi c√≥ r·ªóng kh√¥ng
    if (!newCookie) {
      console.log('‚ùå Empty cookie');
      enableInteraction();
      console.log('üîî Showing alert for empty cookie');
      alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p cookie m·ªõi tr∆∞·ªõc khi c·∫≠p nh·∫≠t!");
      return; // Kh√¥ng ƒë√≥ng modal, ƒë·ªÉ user s·ª≠a
    }
    
    // Ki·ªÉm tra cookie c√≥ qu√° ng·∫Øn kh√¥ng (c√≥ th·ªÉ l√† l·ªói)
    if (newCookie.length < 10) {
      console.log('‚ùå Cookie too short');
      enableInteraction();
      console.log('üîî Showing alert for short cookie');
      alert("‚ö†Ô∏è Cookie c√≥ v·∫ª qu√° ng·∫Øn. Vui l√≤ng ki·ªÉm tra l·∫°i!");
      return; // Kh√¥ng ƒë√≥ng modal, ƒë·ªÉ user s·ª≠a
    }
    
    // Ki·ªÉm tra cookie c√≥ ch·ª©a k√Ω t·ª± ƒë·∫∑c bi·ªát c·∫ßn thi·∫øt kh√¥ng
    if (!newCookie.includes('=')) {
      console.log('‚ùå Cookie invalid format');
      enableInteraction();
      alert("‚ö†Ô∏è Cookie c√≥ v·∫ª kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng. Cookie th∆∞·ªùng ch·ª©a d·∫•u '='.");
      return; // Kh√¥ng ƒë√≥ng modal, ƒë·ªÉ user s·ª≠a
    }

    console.log('‚úÖ All validations passed, proceeding with update');
    
    const { BACKEND_URL } = getConstants();
    showProcessingModal("ƒêang c·∫≠p nh·∫≠t Cookie...");
    
    const response = await fetch(BACKEND_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        action: "updateCookie",
        transactionId: transaction.transactionId,
        accountSheetId: transaction.accountSheetId,
        newCookie: newCookie,
        type: "confirm"
      })
    });
    
    const result = await response.json();
    console.log('üç™ Update result:', result);
    
    closeProcessingModal();
    
    if (result.status === "success") {
      showResultModal("‚úÖ C·∫≠p nh·∫≠t cookie th√†nh c√¥ng!\n\nCookie m·ªõi ƒë√£ ƒë∆∞·ª£c l∆∞u cho giao d·ªãch " + transaction.transactionId, true);
      // Ch·ªâ ƒë√≥ng modal khi th√†nh c√¥ng
      enableInteraction();
      closeUpdateCookieModal();
    } else {
      showResultModal("‚ùå " + (result.message || "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t cookie"), false);
      // Kh√¥ng ƒë√≥ng modal khi th·∫•t b·∫°i, ƒë·ªÉ user th·ª≠ l·∫°i
      enableInteraction();
    }
    
  } catch (err) {
    console.error('‚ùå Error in confirmUpdateCookie:', err);
    closeProcessingModal();
    showResultModal("‚ùå L·ªói khi c·∫≠p nh·∫≠t cookie: " + err.message, false);
    // Kh√¥ng ƒë√≥ng modal khi c√≥ l·ªói, ƒë·ªÉ user th·ª≠ l·∫°i
    enableInteraction();
  }
}

export async function cancelUpdateCookie() {
  console.log('üç™ cancelUpdateCookie called');
  
  try {
    disableInteraction();
    const transaction = window.currentCookieTransaction;
    console.log('üç™ Cancel transaction:', transaction);
    
    if (!transaction?.transactionId) {
      console.log('‚ùå No transaction to cancel');
      enableInteraction();
      closeUpdateCookieModal();
      return;
    }

    const { BACKEND_URL } = getConstants();
    await fetch(BACKEND_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        action: "updateCookie",
        transactionId: transaction.transactionId,
        type: "cancel"
      })
    });
    console.log('‚úÖ Cancel log sent successfully');
    
  } catch (err) {
    console.warn("‚ùå Kh√¥ng th·ªÉ g·ª≠i log h·ªßy c·∫≠p nh·∫≠t cookie:", err.message);
  } finally {
    enableInteraction();
    closeUpdateCookieModal();
  }
}

export function closeUpdateCookieModal() {
  console.log('üç™ closeUpdateCookieModal called');
  const modal = document.getElementById("updateCookieModal");
  if (modal) {
    modal.style.display = "none";
    console.log('‚úÖ Modal closed');
  } else {
    console.error('‚ùå Modal not found');
  }
}

export function closeTestCookieModal() {
  console.log('üß™ closeTestCookieModal called');
  const modal = document.getElementById("testCookieModal");
  if (modal) {
    modal.style.display = "none";
    console.log('‚úÖ Test modal closed');
  } else {
    console.error('‚ùå Test modal not found');
  }
}

export async function runCookieTest() {
  console.log('üß™ runCookieTest called');
  
  const websiteSelect = document.getElementById("testWebsite");
  const customWebsite = document.getElementById("customWebsite");
  const cookie = window.currentTestCookie;
  
  if (!websiteSelect.value) {
    showResultModal("‚ö†Ô∏è Vui l√≤ng ch·ªçn website ƒë·ªÉ test!", false);
    return;
  }
  
  let targetWebsite = "";
  if (websiteSelect.value === "custom") {
    if (!customWebsite.value.trim()) {
      showResultModal("‚ö†Ô∏è Vui l√≤ng nh·∫≠p URL website!", false);
      return;
    }
    targetWebsite = customWebsite.value.trim();
  } else {
    targetWebsite = websiteSelect.value;
  }
  
  console.log('üß™ Testing cookie on:', targetWebsite);
  
  // Show loading
  const resultsDiv = document.getElementById("testResults");
  const resultsContent = document.getElementById("testResultsContent");
  
  resultsDiv.style.display = "block";
  resultsDiv.className = "test-results";
  resultsContent.innerHTML = "üîÑ ƒêang ki·ªÉm tra cookie...";
  
  try {
    // Since we can't actually test cookies cross-origin from frontend,
    // we'll simulate the test or send to backend
    const { BACKEND_URL } = getConstants();
    
    const response = await fetch(BACKEND_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        action: "testCookie",
        website: targetWebsite,
        cookie: cookie
      })
    });
    
    const result = await response.json();
    console.log('üß™ Test result:', result);
    
    if (result.status === "success") {
      resultsDiv.className = "test-results success";
      resultsContent.innerHTML = `
        ‚úÖ <strong>Cookie ho·∫°t ƒë·ªông t·ªët!</strong><br>
        Website: ${targetWebsite}<br>
        Status: ${result.loginStatus || "ƒê√£ ƒëƒÉng nh·∫≠p"}<br>
        ${result.details ? `Chi ti·∫øt: ${result.details}` : ""}
      `;
    } else {
      resultsDiv.className = "test-results error";
      resultsContent.innerHTML = `
        ‚ùå <strong>Cookie kh√¥ng ho·∫°t ƒë·ªông</strong><br>
        Website: ${targetWebsite}<br>
        L·ªói: ${result.message || "Kh√¥ng th·ªÉ ƒëƒÉng nh·∫≠p"}<br>
        ${result.details ? `Chi ti·∫øt: ${result.details}` : ""}
      `;
    }
    
  } catch (err) {
    console.error('‚ùå Test failed:', err);
    resultsDiv.className = "test-results error";
    resultsContent.innerHTML = `
      ‚ùå <strong>L·ªói khi test cookie</strong><br>
      Chi ti·∫øt: ${err.message}<br>
      <em>C√≥ th·ªÉ do v·∫•n ƒë·ªÅ k·∫øt n·ªëi ho·∫∑c website kh√¥ng h·ªó tr·ª£ test t·ª´ xa.</em>
    `;
  }
}

function disableInteraction() {
  console.log('üîí Disabling interaction');
  const overlay = document.getElementById("formOverlay");
  if (overlay) {
    overlay.style.display = "block";
  } else {
    console.error('‚ùå formOverlay not found');
  }
}

function enableInteraction() {
  console.log('üîì Enabling interaction'); 
  const overlay = document.getElementById("formOverlay");
  if (overlay) {
    overlay.style.display = "none";
  } else {
    console.error('‚ùå formOverlay not found');
  }
}
  